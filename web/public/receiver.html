<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知接收器 - 凑面</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- 添加 Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-card {
            transition: all 0.3s ease;
        }

        .notification-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .switch-button {
            transition: background-color 0.3s ease;
        }

        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .welcome-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 欢迎提示框 -->
    <div id="welcome_overlay" class="welcome-overlay">
        <div class="welcome-card">
            <h2 class="text-2xl font-bold mb-4">欢迎使用通知接收器</h2>
            <p class="text-gray-600 mb-6">点击下方按钮开始使用，并测试通知声音</p>
            <button onclick="startApp()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                开始使用
            </button>
        </div>
    </div>
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold text-gray-800">通知接收器</h1>
                <div class="flex items-center space-x-2">
                    <div id="connection_status" class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span id="status_text" class="text-gray-600">等待连接...</span>
                </div>
            </div>
            
            <!-- 声音设置部分 -->
            <div class="bg-gray-50 rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-volume-up mr-2"></i>
                    通知声音设置
                </h2>
                <div class="space-y-6">
                    <!-- 声音开关 -->
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="sound_switch" class="sr-only" checked>
                                <div class="w-10 h-6 bg-gray-300 rounded-full shadow-inner"></div>
                                <div class="dot absolute w-6 h-6 bg-white rounded-full shadow -left-1 -top-1 transition"></div>
                            </div>
                            <span class="ml-3 text-gray-700 font-medium">启用声音</span>
                        </label>
                        <button onclick="testDefaultSound()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                            <i class="fas fa-play mr-2"></i>
                            测试声音
                        </button>
                    </div>

                    <!-- 声音选择 -->
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="sound_type" value="default" class="form-radio text-blue-500" checked>
                                <span class="ml-2 text-gray-700">使用默认声音</span>
                            </label>
                        </div>
                        <div>
                            <label class="inline-flex items-center">
                                <input type="radio" name="sound_type" value="custom" class="form-radio text-blue-500">
                                <span class="ml-2 text-gray-700">使用自定义声音</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 自定义声音上传 -->
                    <div id="custom_sound_section" class="hidden bg-white rounded-lg shadow-sm p-4">
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4">
                                <input type="file" 
                                       id="sound_file" 
                                       accept=".mp3,.wav,.ogg"
                                       class="hidden">
                                <button onclick="document.getElementById('sound_file').click()"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center">
                                    <i class="fas fa-upload mr-2"></i>
                                    选择音频文件
                                </button>
                                <span id="selected_file_name" class="text-gray-600"></span>
                            </div>
                            <div>
                                <button id="upload_button" 
                                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors hidden flex items-center">
                                    <i class="fas fa-check mr-2"></i>
                                    上传文件
                                </button>
                            </div>
                            <!-- 预览播放器 -->
                            <div id="audio_preview" class="hidden">
                                <audio id="audio_player" controls class="w-full"></audio>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 通知历史记录 -->
            <div>
                <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-history mr-2"></i>
                    通知历史
                </h2>
                <div id="notification_history" class="space-y-4">
                    <!-- 通知记录将在这里动态添加 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let customSoundPath = null;
        let notificationSound = null;
        let hasUserInteraction = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let baseReconnectDelay = 1000; // 基础重连延迟（毫秒）

        // 开始应用
        function startApp() {
            hasUserInteraction = true;
            document.getElementById('welcome_overlay').style.display = 'none';
            // 初始化声音
            initDefaultSound();
            // 连接WebSocket
            connectWebSocket();
        }

        // 初始化声音开关样式
        function initSoundSwitch() {
            const checkbox = document.getElementById('sound_switch');
            const dot = checkbox.parentElement.querySelector('.dot');
            
            function updateSwitch() {
                if (checkbox.checked) {
                    dot.style.transform = 'translateX(100%)';
                    checkbox.parentElement.querySelector('div:not(.dot)').classList.remove('bg-gray-300');
                    checkbox.parentElement.querySelector('div:not(.dot)').classList.add('bg-blue-500');
                } else {
                    dot.style.transform = 'translateX(0)';
                    checkbox.parentElement.querySelector('div:not(.dot)').classList.remove('bg-blue-500');
                    checkbox.parentElement.querySelector('div:not(.dot)').classList.add('bg-gray-300');
                }
            }
            
            checkbox.addEventListener('change', updateSwitch);
            updateSwitch(); // 初始化状态
        }

        // 调试函数：检查音频文件
        function debugAudioFile(audioPath) {
            fetch(audioPath)
                .then(response => {
                    console.log('音频文件获取结果:', {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    return response.blob();
                })
                .then(blob => {
                    console.log('音频文件Blob信息:', {
                        size: blob.size,
                        type: blob.type
                    });
                })
                .catch(error => {
                    console.error('音频文件获取失败:', error);
                    showToast('音频文件获取失败', 'error');
                });
        }

        // 初始化默认声音
        function initDefaultSound() {
            console.log('初始化默认声音...');
            try {
                const soundPath = 'uploads/sounds/notification.mp3';
                console.log('尝试加载声音文件:', soundPath);
                
                notificationSound = new Audio(soundPath);
                notificationSound.preload = 'auto';
                
                notificationSound.addEventListener('canplaythrough', () => {
                    console.log('声音加载完成，准备播放测试声音...');
                    if (hasUserInteraction) {
                        testDefaultSound();
                    }
                }, { once: true });
                
                notificationSound.addEventListener('error', (e) => {
                    console.error('加载声音失败:', e);
                    showToast('加载通知声音失败，请检查控制台获取详细信息', 'error');
                });
                
                notificationSound.load();
                
            } catch (err) {
                console.error('初始化声音时发生异常:', err);
                showToast('初始化声音失败: ' + err.message, 'error');
            }
        }

        // 测试默认声音
        function testDefaultSound() {
            console.log('测试默认声音...');
            if (!notificationSound) {
                console.error('声音对象未初始化');
                showToast('声音未初始化，正在重新初始化...', 'warning');
                initDefaultSound();
                return;
            }

            try {
                notificationSound.currentTime = 0;
                notificationSound.play().then(() => {
                    console.log('声音播放成功');
                    showToast('测试声音播放成功', 'success');
                }).catch(e => {
                    console.error('播放声音失败:', e);
                    showToast('播放声音失败: ' + e.message, 'error');
                });
            } catch (err) {
                console.error('播放声音时发生异常:', err);
                showToast('播放声音失败: ' + err.message, 'error');
            }
        }

        // 显示提示信息
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }
        
        // 处理声音类型选择
        document.querySelectorAll('input[name="sound_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const customSection = document.getElementById('custom_sound_section');
                if (this.value === 'custom') {
                    customSection.classList.remove('hidden');
                } else {
                    customSection.classList.add('hidden');
                    initDefaultSound();
                }
            });
        });

        // 处理文件选择
        document.getElementById('sound_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('selected_file_name').textContent = file.name;
                document.getElementById('upload_button').classList.remove('hidden');
                
                const url = URL.createObjectURL(file);
                const audioPlayer = document.getElementById('audio_player');
                audioPlayer.src = url;
                document.getElementById('audio_preview').classList.remove('hidden');
            }
        });

        // 处理文件上传
        document.getElementById('upload_button').addEventListener('click', function() {
            const file = document.getElementById('sound_file').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('sound_file', file);

            fetch('upload_sound.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    customSoundPath = data.file_path;
                    notificationSound = new Audio(customSoundPath);
                    showToast('声音文件上传成功！', 'success');
                } else {
                    showToast('上传失败：' + data.message, 'error');
                }
            })
            .catch(error => {
                showToast('上传出错：' + error, 'error');
            });
        });

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8081');
            
            ws.onopen = function() {
                console.log('WebSocket已连接');
                reconnectAttempts = 0; // 重置重试次数
                document.getElementById('connection_status').className = 'w-3 h-3 rounded-full bg-green-500';
                document.getElementById('status_text').textContent = '已连接';
                showToast('WebSocket连接成功', 'success');
            };
            
            ws.onclose = function() {
                console.log('WebSocket连接已断开');
                document.getElementById('connection_status').className = 'w-3 h-3 rounded-full bg-red-500';
                
                if (reconnectAttempts >= maxReconnectAttempts) {
                    document.getElementById('status_text').textContent = '连接失败，请刷新页面重试';
                    showToast('WebSocket连接失败，已达到最大重试次数', 'error');
                    return;
                }
                
                reconnectAttempts++;
                const delay = Math.min(baseReconnectDelay * Math.pow(1.5, reconnectAttempts - 1), 10000); // 最大10秒
                const remainingAttempts = maxReconnectAttempts - reconnectAttempts;
                
                document.getElementById('status_text').textContent = `连接已断开，${(delay/1000).toFixed(1)}秒后第${reconnectAttempts}次重试...（剩余${remainingAttempts}次）`;
                showToast(`WebSocket连接断开，${(delay/1000).toFixed(1)}秒后重试...`, 'warning');
                
                setTimeout(connectWebSocket, delay);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                document.getElementById('connection_status').className = 'w-3 h-3 rounded-full bg-red-500';
                document.getElementById('status_text').textContent = 'WebSocket错误，等待重新连接...';
                showToast('WebSocket连接错误', 'error');
            };
            
            ws.onmessage = function(event) {
                console.log('收到新消息:', event.data);
                const notification = JSON.parse(event.data);
                
                // 只有在用户已经交互且声音开关打开的情况下才播放声音
                if (hasUserInteraction && notificationSound && document.getElementById('sound_switch').checked) {
                    console.log('尝试播放通知声音...');
                    notificationSound.currentTime = 0;
                    notificationSound.play().then(() => {
                        console.log('通知声音播放成功');
                    }).catch(e => {
                        console.error('播放通知声音失败:', e);
                        showToast('播放通知声音失败', 'error');
                    });
                } else {
                    console.log('声音未播放:', {
                        hasUserInteraction,
                        hasSoundObject: !!notificationSound,
                        soundEnabled: document.getElementById('sound_switch').checked
                    });
                }
                
                if (Notification.permission === "granted") {
                    new Notification(notification.title, {
                        body: notification.content
                    });
                }
                
                addToHistory(notification);
            };
        }
        
        function addToHistory(notification) {
            const history = document.getElementById('notification_history');
            const notificationElement = document.createElement('div');
            notificationElement.className = 'bg-white p-4 rounded-lg shadow-sm notification-card fade-in';
            notificationElement.innerHTML = `
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-800">${notification.title}</h3>
                    <span class="text-sm text-gray-500">${new Date(notification.timestamp).toLocaleString()}</span>
                </div>
                <p class="text-gray-600 mt-2">${notification.content}</p>
            `;
            history.insertBefore(notificationElement, history.firstChild);
        }
        
        // 请求通知权限
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }
        
        // 页面加载完成后显示欢迎界面
        document.addEventListener('DOMContentLoaded', function() {
            // 默认启用声音开关
            document.getElementById('sound_switch').checked = true;
            initSoundSwitch();
            // 立即连接WebSocket，但声音需要等待用户交互
            connectWebSocket();
        });
    </script>
</body>
</html>
