<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥æ”¶é€šçŸ¥</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .notification {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        #notification-container {
            position: fixed;
            bottom: 20px;  /* æ”¹ä¸ºåº•éƒ¨æ˜¾ç¤º */
            right: 20px;
            z-index: 1000;
            max-height: 80vh;  /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto;  /* å¦‚æœé€šçŸ¥å¤ªå¤šï¼Œå…è®¸æ»šåŠ¨ */
        }

        .notification {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            width: 300px;
        }

        /* ç¡®ä¿æ»šåŠ¨æ¡æ ·å¼ç¾è§‚ */
        #notification-container::-webkit-scrollbar {
            width: 6px;
        }

        #notification-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #notification-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #notification-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center mb-6">
                <button id="sound-toggle" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-4">
                    ğŸ”Š å£°éŸ³å¼€å¯
                </button>
                <h2 class="text-2xl font-bold">æ¥æ”¶é€šçŸ¥</h2>
            </div>
            <div id="status" class="mb-4 text-gray-600">ç­‰å¾…è¿æ¥...</div>
            <div id="notifications" class="space-y-2">
                <!-- é€šçŸ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <div id="notification-container">
        <!-- é€šçŸ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>

    <script>
        let soundEnabled = true;
        let audioContext = null;
        let soundBuffer = null;

        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºä¸€ä¸ªç®€çŸ­çš„æç¤ºéŸ³
                const duration = 0.2;  // æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
                const sampleRate = audioContext.sampleRate;
                const numSamples = duration * sampleRate;
                const buffer = audioContext.createBuffer(1, numSamples, sampleRate);
                const data = buffer.getChannelData(0);
                
                // ç”Ÿæˆä¸€ä¸ªç®€å•çš„"å®"å£°
                for (let i = 0; i < numSamples; i++) {
                    const t = i / sampleRate;
                    // æ··åˆä¸¤ä¸ªé¢‘ç‡åˆ›å»ºæ›´æ‚¦è€³çš„å£°éŸ³
                    const frequency1 = 880;  // A5éŸ³ç¬¦
                    const frequency2 = 1320; // E6éŸ³ç¬¦
                    data[i] = (Math.sin(2 * Math.PI * frequency1 * t) * 0.5 +
                              Math.sin(2 * Math.PI * frequency2 * t) * 0.3) *
                             Math.exp(-4 * t);  // æŒ‡æ•°è¡°å‡
                }
                
                soundBuffer = buffer;
                console.log('éŸ³é¢‘åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function playNotificationSound() {
            if (!audioContext || !soundBuffer) {
                console.log('éŸ³é¢‘æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...');
                initAudio().then(() => {
                    playSound();
                });
                return;
            }
            playSound();
        }

        function playSound() {
            if (!soundEnabled || !audioContext || !soundBuffer) return;
            
            try {
                const source = audioContext.createBufferSource();
                source.buffer = soundBuffer;
                source.connect(audioContext.destination);
                source.start(0);
                console.log('æ’­æ”¾æç¤ºéŸ³æˆåŠŸ');
            } catch (error) {
                console.error('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', error);
            }
        }

        document.getElementById('sound-toggle').addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'ğŸ”Š å£°éŸ³å¼€å¯' : 'ğŸ”‡ å£°éŸ³å…³é—­';
            
            if (soundEnabled && audioContext?.state === 'suspended') {
                audioContext.resume();
            }
        });

        // åˆå§‹åŒ–éŸ³é¢‘
        initAudio();

        const ws = new WebSocket('ws://localhost:8081');
        const statusDiv = document.getElementById('status');
        const notificationsDiv = document.getElementById('notifications');
        
        ws.onopen = function() {
            statusDiv.textContent = 'WebSocketå·²è¿æ¥';
            statusDiv.className = 'text-green-600';
        };
        
        ws.onclose = function() {
            statusDiv.textContent = 'WebSocketå·²æ–­å¼€';
            statusDiv.className = 'text-red-600';
        };
        
        ws.onerror = function(error) {
            console.error('WebSocketé”™è¯¯:', error);
            statusDiv.textContent = 'WebSocketé”™è¯¯';
            statusDiv.className = 'text-red-600';
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'notification') {
                    // æ·»åŠ åˆ°é€šçŸ¥åˆ—è¡¨
                    const notificationDiv = document.createElement('div');
                    notificationDiv.className = 'notification';
                    notificationDiv.innerHTML = `
                        <h3>${data.title}</h3>
                        <p>${data.content}</p>
                        <div class="timestamp">${new Date(data.timestamp).toLocaleString()}</div>
                    `;
                    notificationsDiv.insertBefore(notificationDiv, notificationsDiv.firstChild);
                    
                    // æ˜¾ç¤ºå¼¹å‡ºé€šçŸ¥
                    showPopupNotification(data.title, data.content);
                    
                    // æ’­æ”¾æç¤ºéŸ³
                    playNotificationSound();
                }
            } catch (error) {
                console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
            }
        };
        
        function showPopupNotification(title, content) {
            const popup = document.createElement('div');
            popup.className = 'notification';
            popup.innerHTML = `
                <h3>${title}</h3>
                <p>${content}</p>
            `;
            document.getElementById('notification-container').appendChild(popup);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('notification-container').removeChild(popup);
                }, 500);
            }, 5000);
        }
    </script>
</body>
</html>
